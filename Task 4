

--CREATING TRIGGERS ON ANY ACTION--
CREATE TRIGGER TR_IN_ORD
ON ORDERS
FOR INSERT
AS 
BEGIN
	DECLARE @QR AS INT;
	DECLARE @QS AS INT;

	SET @QR = (SELECT OQTY FROM INSERTED)
	SET @QS = (SELECT SQTY FROM STOCK WHERE PID=(SELECT PID FROM INSERTED));
	 
	IF @QS>= @QR
		BEGIN
			UPDATE STOCK SET SQTY= SQTY-@QR
			WHERE PID=(SELECT PID FROM INSERTED);
			COMMIT;
			PRINT('ORDER ACCEPTED');
		END;
	ELSE
		BEGIN
			ROLLBACK;
			PRINT('INSUFFICIENT STOCK - ORDER REJECTED');
		END;
END;

CREATE TRIGGER TR_DE_PRO
ON PRODUCT 
FOR DELETE
AS
BEGIN
	DELETE FROM STOCK
	WHERE PID = (SELECT PID FROM DELETED);
END;

CREATE TRIGGER TR_UP_ORD
ON ORDERS
FOR UPDATE
AS BEGIN
	DECLARE @OLDQTY AS INT;
	DECLARE @NEWQTY AS INT;

	SET @OLDQTY = (SELECT OQTY FROM DELETED);
	SET @NEWQTY = (SELECT OQTY FROM INSERTED);

	UPDATE STOCK SET SQTY = SQTY + @OLDQTY - @NEWQTY
	WHERE PID = (SELECT PID FROM INSERTED);
END;


CREATE TRIGGER TR_DE_ORD
ON ORDERS
FOR DELETE
AS BEGIN
	DECLARE @QTY AS INT;
	SET @QTY = (SELECT OQTY FROM DELETED);

	UPDATE STOCK SET SQTY= SQTY+@QTY 
	WHERE PID = (SELECT PID FROM DELETED);
	SELECT * FROM ORDERS;
	SELECT * FROM STOCK;
END;
